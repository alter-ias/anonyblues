<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALGO-RITMO | ANONYBLUES</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap">
    <style>
        /* --- (Estilos sin cambios) --- */
        body { margin: 0; overflow: hidden; font-family: 'Orbitron', sans-serif; background: #000; cursor: default; }
        #intro-video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; background-color: #000; cursor: pointer; transition: opacity 1s ease-out; }
        #intro-video { width: 100%; height: 100%; object-fit: cover; }
        #skip-intro-text { position: absolute; bottom: 20px; right: 20px; color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; text-shadow: 0 0 5px black; pointer-events: none; z-index: 301; }
        #toggle-mute-button { position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.5); color: #0FF; border: 1px solid #0FF; border-radius: 5px; padding: 8px 12px; font-family: 'Orbitron', sans-serif; font-size: 0.9rem; cursor: pointer; z-index: 301; text-shadow: 0 0 5px #0FF; transition: background-color 0.3s, color 0.3s; }
        #toggle-mute-button:hover { background: rgba(0, 255, 255, 0.2); color: white; }
        #canvas-container, #ui { opacity: 0; pointer-events: none; transition: opacity 1.5s ease-out; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #ui { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); color: #0FF; text-align: center; text-shadow: 0 0 10px #0FF; z-index: 100; width: 90%; max-width: 800px; pointer-events: none; }
        #ui .social-links a { pointer-events: auto; }
        .main-title { margin-bottom: 5px; font-size: 1.2rem; }
        .song-title { font-size: 1.5rem; margin-bottom: 10px; opacity: 0; transition: opacity 0.5s; height: 1.8em; }
        .social-links { margin-top: 5px; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
        .social-links a { color: #FF00FF; text-decoration: none; font-size: 0.8rem; transition: opacity 0.3s, text-shadow 0.3s; text-shadow: 0 0 8px #FF00FF; }
        .social-links a:hover { opacity: 0.8; text-shadow: 0 0 15px #FF00FF; }
        #video-container { position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 70vw; height: 39.375vw; max-width: 900px; max-height: 506px; z-index: 200; display: none; border: 3px solid #0FF; box-shadow: 0 0 30px #0FF; background: black; opacity: 0; transition: opacity 0.5s ease-out; }
        #close-video { position: absolute; top: -20px; right: -20px; background: #FF00FF; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; z-index: 201; line-height: 40px; text-align: center; }
        body.app-active { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="10" fill="none" stroke="%23FF00FF" stroke-width="3"/></svg>'), auto; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script type="importmap">
    { "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.175.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.175.0/examples/jsm/"
    } }
    </script>
</head>
<body>
    <!-- Intro Video -->
    <div id="intro-video-container"><video id="intro-video" src="./assets/videos/fondo.mp4" autoplay muted playsinline></video><span id="skip-intro-text">Saltar Intro</span><button id="toggle-mute-button">Activar Sonido</button></div>
    <!-- Contenido Principal -->
    <div id="canvas-container"></div>
    <div id="ui"><div class="song-title" id="song-title"></div><div class="main-title">ALGO-RITMO | ANONYBLUES</div><div class="social-links"><a href="INSTAGRAM_URL" target="_blank" rel="noopener noreferrer">Instagram</a> <a href="YOUTUBE_URL" target="_blank" rel="noopener noreferrer">YouTube</a> <a href="FACEBOOK_URL" target="_blank" rel="noopener noreferrer">Facebook</a> <a href="PATREON_URL" target="_blank" rel="noopener noreferrer">Patreon</a></div></div>
    <div id="video-container"><iframe id="yt-player" width="100%" height="100%" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe><button id="close-video">×</button></div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Elementos DOM ---
        const introContainer = document.getElementById('intro-video-container'); const introVideo = document.getElementById('intro-video'); const toggleMuteButton = document.getElementById('toggle-mute-button'); const canvasContainer = document.getElementById('canvas-container'); const uiElement = document.getElementById('ui'); const videoContainer = document.getElementById('video-container'); const ytPlayer = document.getElementById('yt-player'); const closeVideoBtn = document.getElementById('close-video'); const songTitleElement = document.getElementById('song-title'); const bodyElement = document.body;

        // --- Estado ---
        let introFinished = false; let isPlayerActive = false; let controls; let currentlyPlayingPlanet = null; let hoveredPlanet = null;

        // --- Constantes de Configuración (Tus valores perfectos) ---
        const CAMERA_VIEW_POSITION = new THREE.Vector3(0, 2, 78);
        const PLANET_ALIGNMENT_Y = -4;
        const PLANET_ALIGNMENT_Z = 65;
        const PLANET_SPACING = 2;
        const ALIGNED_PLANET_SCALE = 0.05; // <<< ¡¡MUY PEQUEÑO!! Considera 0.15 o 0.2 si hay problemas de click
        const INITIAL_CAMERA_Z = 100;
        const CAMERA_LOOKAT_TARGET_PLAYER = new THREE.Vector3(0, PLANET_ALIGNMENT_Y * 0.7, 0);
        const CAMERA_LOOKAT_TARGET_INITIAL = new THREE.Vector3(0, 0, 0);

        // --- Funciones Intro (sin cambios) ---
        function startMainExperience() { /* ... */ if (introFinished) return; introFinished = true; introVideo.pause(); introVideo.muted = true; toggleMuteButton.textContent = 'Activar Sonido'; gsap.to(introContainer, { opacity: 0, duration: 1, onComplete: () => { introContainer.style.display = 'none'; toggleMuteButton.removeEventListener('click', handleToggleMute); }}); canvasContainer.style.opacity = 0; uiElement.style.opacity = 0; canvasContainer.style.pointerEvents = 'auto'; gsap.to([canvasContainer, uiElement], { opacity: 1, duration: 1.5, delay: 0.5 }); bodyElement.classList.add('app-active'); if (controls) { controls.enabled = true; controls.autoRotate = true; } introContainer.removeEventListener('click', startMainExperience); introVideo.removeEventListener('ended', startMainExperience); }
        function handleToggleMute(event) { /* ... */ event.stopPropagation(); const isMuted = introVideo.muted; introVideo.muted = !isMuted; toggleMuteButton.textContent = introVideo.muted ? 'Activar Sonido' : 'Silenciar'; }
        introContainer.addEventListener('click', startMainExperience); toggleMuteButton.addEventListener('click', handleToggleMute); introVideo.addEventListener('ended', startMainExperience);

        // --- INICIALIZACIÓN THREE.JS (sin cambios) ---
        const scene = new THREE.Scene(); const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000); const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); renderer.outputEncoding = THREE.sRGBEncoding; canvasContainer.appendChild(renderer.domElement); const composer = new EffectComposer(renderer); composer.addPass(new RenderPass(scene, camera)); const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85); composer.addPass(bloomPass); controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.dampingFactor = 0.05; controls.screenSpacePanning = false; controls.minDistance = 10; controls.maxDistance = 150; controls.autoRotate = false; controls.enabled = false; const ambientLight = new THREE.AmbientLight(0x404040, 2); scene.add(ambientLight); const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5); directionalLight.position.set(5, 10, 7); scene.add(directionalLight); const particlesGeometry = new THREE.BufferGeometry(); const particlesCount = 7000; const posArray = new Float32Array(particlesCount * 3); for(let i = 0; i < particlesCount * 3; i++) posArray[i] = (Math.random() - 0.5) * 300; particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3)); const particlesMaterial = new THREE.PointsMaterial({ size: 0.1, color: 0x00ffff, transparent: true, opacity: 0.7, blending: THREE.AdditiveBlending }); const particlesSystem = new THREE.Points(particlesGeometry, particlesMaterial); scene.add(particlesSystem); const textureLoader = new THREE.TextureLoader();
        const songs = [ /* ... Tu array de canciones ... */
             { title: "LA NAVE NODRIZA", ytId: "7LQLXalnl_0", texturePath: './assets/textures/nave-nodriza.jpg', color: 0x00ffff, size: 8, initialPosition: new THREE.Vector3(-30, 10, -50), atmosphereColor: 0x0066ff, ring: true },
             { title: "LA PANTALLA DE CRISTAL", ytId: "oA_2wYnBmxo", texturePath: './assets/textures/pantalla-cristal.jpg', color: 0xff00ff, size: 7, initialPosition: new THREE.Vector3(25, 10, -40), atmosphereColor: 0xff00aa, ring: false },
             { title: "LA MANZANA QUE TE PUDRE", ytId: "VIDEO_ID_3", texturePath: './assets/textures/manzana-podrida.jpg', color: 0xff3300, size: 6, initialPosition: new THREE.Vector3(0, -15, -60), atmosphereColor: 0xff6600, ring: true },
             { title: "NOSTRADAMUS DIGITAL", ytId: "VIDEO_ID_4", texturePath: './assets/textures/nostradamus-digital.jpg', color: 0xffff00, size: 7.5, initialPosition: new THREE.Vector3(40, -5, -70), atmosphereColor: 0xffee00, ring: false },
             { title: "FUNKYFANS", ytId: "VIDEO_ID_5", texturePath: './assets/textures/funkyfans.jpg', color: 0x9900ff, size: 6.5, initialPosition: new THREE.Vector3(-20, 20, -30), atmosphereColor: 0xcc00ff, ring: true },
             { title: "EL BLUES DEL AMOR ARTIFICIAL", ytId: "VIDEO_ID_6", texturePath: './assets/textures/blues-amor-artificial.jpg', color: 0x00ff99, size: 7, initialPosition: new THREE.Vector3(10, -25, -45), atmosphereColor: 0x00cc99, ring: false }
        ];
        const planets = [];
        songs.forEach(song => { /* ... Creación de planetas ... */ const texture = textureLoader.load(song.texturePath); texture.encoding = THREE.sRGBEncoding; const geometry = new THREE.SphereGeometry(song.size, 64, 64); const material = new THREE.MeshStandardMaterial({ map: texture, emissive: song.color, emissiveIntensity: 0.6, metalness: 0.1, roughness: 0.8, side: THREE.FrontSide }); material.userData = { originalEmissiveIntensity: material.emissiveIntensity }; const planet = new THREE.Mesh(geometry, material); planet.position.copy(song.initialPosition); song.originalPosition = song.initialPosition.clone(); planet.userData = song; const atmosphereGeometry = new THREE.SphereGeometry(song.size * 1.15, 64, 64); const atmosphereMaterial = new THREE.MeshPhongMaterial({ color: song.atmosphereColor, transparent: true, opacity: 0.35, blending: THREE.AdditiveBlending, side: THREE.BackSide }); const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial); planet.add(atmosphere); if(song.ring) { const ringGeometry = new THREE.RingGeometry(song.size * 1.5, song.size * 1.8, 64); const ringMaterial = new THREE.MeshBasicMaterial({ color: song.color, side: THREE.DoubleSide, transparent: true, opacity: 0.6 }); const ring = new THREE.Mesh(ringGeometry, ringMaterial); ring.rotation.x = Math.PI * 0.45; ring.rotation.y = Math.PI * 0.1; planet.add(ring); } scene.add(planet); planets.push(planet); });

        // ========== INTERACCIÓN REVISADA ==========
        const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2(-10, -10);

        // --- Set Planet Highlight State ---
        function setPlanetHighlight(planet, highlighted = true) { /* ... (igual, solo brillo) ... */ if (!planet || !planet.material) return; const originalIntensity = planet.material.userData?.originalEmissiveIntensity ?? 0.6; const targetIntensity = highlighted ? originalIntensity * 2.5 : originalIntensity; gsap.to(planet.material, { emissiveIntensity: targetIntensity, duration: 0.4 }); }

        // --- Hover MODIFICADO (No cambia título si player activo) ---
        function onMouseMove(event) {
             if (!introFinished) return;

             mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
             mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

             // Si el player está activo, no hacemos NADA con el hover visual
             if (isPlayerActive) {
                 // Limpiar estado de hover si existía
                 if (hoveredPlanet) {
                    // No ocultar el título principal aquí, solo el de hover
                    // songTitleElement.style.opacity = 0;
                    hoveredPlanet = null;
                 }
                 return;
             }

             // Player NO activo: Lógica de hover normal
             raycaster.setFromCamera(mouse, camera);
             const intersects = raycaster.intersectObjects(planets);
             const target = (intersects.length > 0) ? intersects[0].object : null;

             if (target) {
                 if (hoveredPlanet !== target) {
                     // Deseleccionar anterior
                     if (hoveredPlanet) {
                         gsap.to(hoveredPlanet.scale, { x: 1, y: 1, z: 1, duration: 0.3 });
                         songTitleElement.style.opacity = 0; // Ocultar título anterior
                     }
                     hoveredPlanet = target;
                     songTitleElement.textContent = hoveredPlanet.userData.title; // Mostrar título hover
                     songTitleElement.style.opacity = 1;
                     gsap.to(hoveredPlanet.scale, { x: 1.15, y: 1.15, z: 1.15, duration: 0.3 });
                     bloomPass.strength = 1.6;
                 }
             } else {
                 // Salir de hover
                 if (hoveredPlanet) {
                     songTitleElement.style.opacity = 0; // Ocultar título hover
                     gsap.to(hoveredPlanet.scale, { x: 1, y: 1, z: 1, duration: 0.3 });
                     hoveredPlanet = null;
                     bloomPass.strength = 1.0;
                 }
             }
        }


        // --- Click MODIFICADO (Mantiene título visible) ---
        function onClick() {
             if (!introFinished) return;
             raycaster.setFromCamera(mouse, camera);
             const intersects = raycaster.intersectObjects(planets);

             if (intersects.length > 0) {
                 const clickedPlanet = intersects[0].object;

                 if (!isPlayerActive) {
                     // --- PRIMER CLICK ---
                     isPlayerActive = true; controls.enabled = false; controls.autoRotate = false;
                     // Limpiar hover visual si existe (pero no ocultar título aún)
                     if (hoveredPlanet) {
                         gsap.to(hoveredPlanet.scale, { x: 1, y: 1, z: 1, duration: 0.1 });
                         // No ocultar título aquí -> songTitleElement.style.opacity = 0;
                         hoveredPlanet = null;
                     }
                     setPlanetHighlight(currentlyPlayingPlanet, false);
                     currentlyPlayingPlanet = clickedPlanet;

                     // *** NUEVO: Establecer y mostrar título del planeta clickeado ***
                     songTitleElement.textContent = currentlyPlayingPlanet.userData.title;
                     songTitleElement.style.opacity = 1;

                     const totalWidth = (planets.length - 1) * PLANET_SPACING; const startX = -totalWidth / 2;
                     const tl = gsap.timeline({ defaults: { duration: 1.2, ease: "power3.inOut" } });
                     tl.to(camera.position, { x: CAMERA_VIEW_POSITION.x, y: CAMERA_VIEW_POSITION.y, z: CAMERA_VIEW_POSITION.z, onUpdate: () => camera.lookAt(CAMERA_LOOKAT_TARGET_PLAYER) }, "start");
                     tl.to(controls.target, { x: CAMERA_LOOKAT_TARGET_PLAYER.x, y: CAMERA_LOOKAT_TARGET_PLAYER.y, z: CAMERA_LOOKAT_TARGET_PLAYER.z }, "start");
                     planets.forEach((planet, index) => {
                         const targetX = startX + index * PLANET_SPACING;
                         tl.to(planet.position, { x: targetX, y: PLANET_ALIGNMENT_Y, z: PLANET_ALIGNMENT_Z }, "start+=0.1");
                         tl.to(planet.rotation, { y: 0, x:0, z:0 }, "start+=0.1");
                         tl.to(planet.scale, { x: ALIGNED_PLANET_SCALE, y: ALIGNED_PLANET_SCALE, z: ALIGNED_PLANET_SCALE }, "start+=0.1");
                     });
                     tl.add(() => {
                         setPlanetHighlight(currentlyPlayingPlanet, true); // Resaltar
                         ytPlayer.src = `https://www.youtube.com/embed/${clickedPlanet.userData.ytId}?autoplay=1&rel=0&showinfo=0&modestbranding=1`;
                         videoContainer.style.display = 'block';
                         gsap.to(videoContainer, { opacity: 1, duration: 0.5 });
                     }, "-=0.5");

                 } else {
                      // --- CLICK POSTERIOR ---
                     if (clickedPlanet === currentlyPlayingPlanet) return;

                     setPlanetHighlight(currentlyPlayingPlanet, false);
                     setPlanetHighlight(clickedPlanet, true);
                     currentlyPlayingPlanet = clickedPlanet;

                     // *** NUEVO: Actualizar y asegurar visibilidad del título ***
                     songTitleElement.textContent = currentlyPlayingPlanet.userData.title;
                     songTitleElement.style.opacity = 1;

                     // Limpiar hover visual si estaba sobre otro planeta
                     if(hoveredPlanet && hoveredPlanet !== clickedPlanet) {
                         // No necesitamos ocultar el título principal
                         hoveredPlanet = null;
                     }

                     gsap.to(ytPlayer, {opacity: 0, duration: 0.3, onComplete: () => { ytPlayer.src = `https://www.youtube.com/embed/${clickedPlanet.userData.ytId}?autoplay=1&rel=0&showinfo=0&modestbranding=1`; gsap.to(ytPlayer, {opacity: 1, duration: 0.3, delay: 0.1}); }});
                 }
             }
        }

        // --- Cerrar Video MODIFICADO (Oculta título) ---
        closeVideoBtn.addEventListener('click', () => {
             if (!isPlayerActive) return; isPlayerActive = false;
             setPlanetHighlight(currentlyPlayingPlanet, false); currentlyPlayingPlanet = null;
             songTitleElement.style.opacity = 0; // *** Ocultar título al cerrar ***
             gsap.to(videoContainer, { opacity: 0, duration: 0.5, onComplete: () => { videoContainer.style.display = 'none'; ytPlayer.src = ''; }});
             const tl = gsap.timeline({ defaults: { duration: 1.2, ease: "power3.inOut" } });
             planets.forEach(planet => {
                 tl.to(planet.position, { x: planet.userData.originalPosition.x, y: planet.userData.originalPosition.y, z: planet.userData.originalPosition.z }, "start");
                 tl.to(planet.scale, { x: 1, y: 1, z: 1 }, "start"); // Restaurar escala
             });
             tl.to(camera.position, { x: 0, y: 0, z: INITIAL_CAMERA_Z, onUpdate: () => camera.lookAt(CAMERA_LOOKAT_TARGET_INITIAL) }, "start+=0.1");
             tl.to(controls.target, { x: CAMERA_LOOKAT_TARGET_INITIAL.x, y: CAMERA_LOOKAT_TARGET_INITIAL.y, z: CAMERA_LOOKAT_TARGET_INITIAL.z }, "start+=0.1");
             tl.add(() => { controls.enabled = true; controls.autoRotate = true; bloomPass.strength = 1.0; });
        });

        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('click', onClick);

        // ========== ANIMACIÓN ==========
        function animate() { /* ... (igual que antes) ... */ requestAnimationFrame(animate); if (introFinished) { if (!isPlayerActive) { const delta = 0.003; planets.forEach(planet => { if (planet !== currentlyPlayingPlanet && planet !== hoveredPlanet) { planet.rotation.y += delta; } }); } particlesSystem.rotation.y += 0.0001; controls.update(); try { composer.render(); } catch (e) { console.error("Error during render:", e); } } }
        camera.position.set(0, 0, INITIAL_CAMERA_Z); camera.lookAt(CAMERA_LOOKAT_TARGET_INITIAL); animate();

        // ========== RESIZE HANDLER ==========
        window.addEventListener('resize', () => { /* ... (igual que antes) ... */ if (!introFinished) return; camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); });

    </script>
</body>
</html>
